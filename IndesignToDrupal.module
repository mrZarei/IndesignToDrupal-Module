<?php
/**
* @file
* A description of what your module does.
*/

require_once 'includes/idt.node.inc';
require_once 'includes/idt.ckeditor.php';

/**
 * Implement hook_permission()
 */
function IndesignToDrupal_permission()
{
    return array(
        'Import from html'=>array(
            'title' => t('Indesign to drupal'),
            'description' => t('Importing html file from indsign to drupal database.'),
        ),
    );
}

/**
 * Implement hook_menu().
 */
function IndesignToDrupal_menu(){
    $item=array();
    $items['admin/config/content/htmlImport'] = array(
        'title' => 'Indesign to Drupal',
        'type' => MENU_NORMAL_ITEM,
        'page callback' => 'drupal_get_form',
        'page arguments' => array('IndesignToDrupal_setting_form'),
        'access arguments' =>array('Import from html'),
        'weight' => 1,
    );
    $items['admin/config/content/htmlImport/setting'] = array(
        'title' => 'settings',
        'type' => MENU_DEFAULT_LOCAL_TASK,
        'page callback' => 'drupal_get_form',
        'page arguments' => array('IndesignToDrupal_setting_form'),
        'access arguments' =>array('Import from html'),
        'weight' => 6,
    );
    $items['admin/config/content/htmlImport/Which-fields'] = array(
        'title' => 'Fields',
        'type' => MENU_LOCAL_TASK,
        'page callback' => 'drupal_get_form',
        'page arguments' => array('IndesignToDrupal_setting_fields_form'),
        'access arguments' =>array('Import from html'),
        'weight' => 7,
    );
    $items['myImages/add'] = array(
        'title' => 'Add',
        'type' => MENU_CALLBACK,
        'page callback' => 'drupal_get_form',
        'page arguments' => array('IndesignToDrupal_add_form'),
        'access arguments' =>array('Import from html'),
        'weight' => 7,
    );
    return $items;
}

function IndesignToDrupal_setting_form($form,&$form_state){

    $form=array();
    $fields=field_info_instances('node','article');
    if(variable_get('itd_title_active',0)) {
        $form['itd_title_classes'] = array(
            '#type' => 'textarea',
            '#title' => t('title'),
            '#default_value' => variable_get('itd_title_classes', ''),
        );
    }
    foreach($fields as $field){
        if(variable_get('itd_'.$field['field_name'].'_active',0)) {
            $form['itd_' . $field['field_name'] . '_classes'] = array(
                '#type' => 'textarea',
                '#title' => $field['label'],
                '#default_value' => variable_get('itd_' . $field['field_name'] . '_classes', ''),
            );
        }
    }
    return system_settings_form($form);
}

function IndesignToDrupal_setting_fields_form($form,&$form_state){
    $fields=field_info_instances('node','article');
    $form['itd-fields']=array(
        '#type' => 'fieldset',
        '#title' => t("Fields of Article"),
        '#collapsible' => False,
    );
    $form['itd-fields']['itd_title_active'] = array(
        '#title' => t('title'),
        '#type' => 'checkbox',
        '#default_value' => variable_get('itd_title_active',0),
    );
    foreach($fields as $field){
        $form['itd-fields']["itd_".$field['field_name']."_active"] = array(
            '#title' => $field['label'],
            '#type' => 'checkbox',
            '#description' => $field['field_name'],
            '#default_value' => variable_get("itd_".$field['field_name']."_active",0),
        );
    }
    return system_settings_form($form);
}

/**
 * Implements hook_field_extra_fields().
 */
function IndesignToDrupal_field_extra_fields()
{
    $extra['node']['article'] = array(
        'form' => array(
            'ITD_import_box' => array(
                'label' => t('Import from HTML'),
                'description' => t('Importing from Indesign html file'),
                'weight' => 0,
            ),
        ),
    );

    return $extra;
}
/**
 * Implements hook_form_alter().
 */
function IndesignToDrupal_form_alter(&$form, &$form_state, $form_id)
{

    if ($form_id == 'article_node_form') {
        $settings=array();
        $fields=field_info_instances('node','article');
        if (variable_get('itd_title_active', 0)) {
            $classes = variable_get('itd_title_classes', '');
            $classes = explode(",",$classes);
            $name = 'title';
            $type='textfield';
            $settings[]=array('name'=>$name,'class'=>$classes,'type'=>$type);
        }
        foreach($fields as $field) {
            if (variable_get('itd_' . $field['field_name'] . '_active', 0)) {
                $classes = variable_get('itd_' . $field['field_name'] . '_classes', '');
                $classes = explode(",",$classes);
                $name = $field['field_name'];
                $type=$field['widget']['type'];
                $settings[]=array('name'=>$name,'class'=>$classes,'type'=>$type);
            }
        }
        $form['ITD_import_box'] = array(
            '#type' => 'fieldset',
            '#title' => t('HTML Import'),
            '#collapsible' => True,
            '#collapsed' => False,
            '#group' => variable_get('domain_vertical_tab', 0) ? 'additional_settings' : '',
            '#attached' => array(
                'js'=> array(drupal_get_path('module', 'IndesignToDrupal') . '/js/itd.js' => array(
                    'type' => 'file',
                    ),
                ),
            ),
        );
        $form['ITD_import_box']['html_file'] = array(
            '#type' => 'markup',
            '#title' => t('input file'),
            '#markup' => '<input type="file" id="itd-file" style="display:block"/>',
        );
        $form['ITD_import_box']['file_display'] = array(
            '#type' => 'markup',
            '#title' => t('Imported file display:'),
            '#markup' => '<iframe id="itd-iframe" style="width: 50%;border: 1px solid #CCC;padding: 10px;margin: 10px 0;height: 400px;"></iframe>',
        );
        $form['ITD_import_box']['file_import_button'] = array(
            '#type' => 'markup',
            '#markup' => '<input type="button" id="convert-btn" value="Import" style="display: block;padding: 5px 15px;border: 1px solid;cursor: pointer;">',
        );
        $form['#attached']['js'][] = array(
            'data' => array('itd' => array('fields' => $settings)),
            'type' => 'setting',
        );
    }
    return $form;
}

/**
 * @param $form
 * @param $from_state
 */
function IndesignToDrupal_add_form($form, &$from_state){

    $form['picture_upload'] = array(
        '#type' => 'plupload',
        '#title' => t(''),
        '#size' => 50,
        '#description' => t(''),
        '#upload_validators' => array(
            'file_validate_extensions' => array('jpg jpeg gif png html      '),
            'my_custom_file_validator' => array('some validation criteria'),
        ),
    );
    $form['form_submit'] = array(
        '#type' => 'submit',
        '#value' =>'submit',
    );
    return $form;
}
function IndesignToDrupal_add_form_submit($form, &$form_state){



    // We can't use file_save_upload() because of
    // http://www.jacobsingh.name/content/tight-coupling-no-not
    // file_uri_to_object();
    $htmls = array();
    $images = array();

    //Separating Html files and images and storing them in the arrays.
    foreach ($form_state['values']['picture_upload'] as $uploaded_file) {
        if ($uploaded_file['status'] == 'done') {
            if(preg_match("/\\.html$/i",$uploaded_file['name'])){
              $htmls[$uploaded_file['name']]=$uploaded_file;
            }
            else{
                $images[$uploaded_file['name']]=$uploaded_file;
            }
        }
        else {
            // @todo: move this to element validate or something and clean up t().
            form_set_error('ITD', "Upload of {$uploaded_file['name']} failed");
        }
    }


    //Check if any html file has been uploaded successfully.
    //if no then print proper msg.
    if( count($htmls)){

        //Get settings
        $settings=array();
        $fields=field_info_instances('node','article');
        if (variable_get('itd_title_active', 0)) {
            $classes = variable_get('itd_title_classes', '');
            $classes = explode(",",$classes);
            $name = 'title';
            $type='textfield';
            $settings[]=array('name'=>$name,'class'=>$classes,'type'=>$type);
        }
        foreach($fields as $field) {
            if (variable_get('itd_' . $field['field_name'] . '_active', 0)) {
                $classes = variable_get('itd_' . $field['field_name'] . '_classes', '');
                $classes = explode(",",$classes);
                $name = $field['field_name'];
                $type=$field['widget']['type'];
                $settings[]=array('name'=>$name,'class'=>$classes,'type'=>$type);
            }
        }
        //Parse Html files
        $result=array();
        foreach ($htmls as $html_file){
            $result[]=_html_to_node($html_file, $images,$settings);
        }
    }
    else{
        // @todo: move this to element validate or something and clean up t().
        form_set_error('ITD', "Could not find any HTML file!");
    }

}


function _html_to_node($html_file,$images,$settings){

    $scheme = variable_get('file_default_scheme', 'public') . '://convert-index.html';
    $source = $html_file['tmppath'];
    $destination = file_stream_wrapper_uri_normalize($scheme);
    // Rename it to its original name, and put it in its final home.
    // Note - not using file_move here because if we call file_get_mime
    // (in file_uri_to_object) while it has a .tmp extension, it horks.
    $destination = file_unmanaged_move($source, $destination, FILE_EXISTS_REPLACE);
    $file = plupload_file_uri_to_object($destination);
    $doc = new DOMDocument();
    if($wrapper=file_stream_wrapper_get_instance_by_uri("public://")){
        $path=$wrapper->realpath();
    }
    $doc->loadHTMLFile($path."\\convert-index.html");
    $xpath = new DOMXPath($doc);
    $result=array();

    foreach($settings as $field){
        $is_field_text_area=preg_match('/text_textarea/i',$field['type']);
        $is_field_atom_reference=preg_match('/atom_reference/i',$field['type']);
        $image_pattern='/^img_/i';
        $query=implode("' or @class='",$field['class']);
        $query = "//*[@class='" . $query . "']";
        $elements = $xpath->query($query);
        if (!is_null($elements)) {
            $field_value=array();
            foreach ($elements as $element) {
                $nodes = $element->childNodes;
                $class = $element->getAttribute('class');
                foreach ($nodes as $node) {
                    $tag = $node->nodeValue;
                    //Check if field is text area.
                    if($is_field_text_area) {
                        //Check if element is image then upload related image and wrap it in img tag.
                        if(preg_match($image_pattern,$class)){
                            $image_info=_parse_image_value($node->nodeValue);
                            if(count($image_info)) {
                                $image_name = $image_info['image_name'];
                                $image_sid = _move_from_temp($images[$image_name],$image_info);
                                $atom = scald_atom_load($image_sid);
                                $render_image = _atom_image_wrapper($atom);
                                $tag = $render_image['render'];
                            }
                            else{
                                form_set_error('IDT',"Class {$class} does not have valid value!");
                            }
                        }
                        else {
                            $ck = new idtCkeditor();
                            $element_tag ="p";
                            $element_attr ="";
                            if($style=$ck->get_ckeditor_style($class)){
                                $element_tag=$style['element'];
                                foreach($style['attributes'] as $attribute=>$attValue){
                                    $element_attr .=' ' .$attribute ."='".$attValue ."'";
                                }
                            }
                            $tag = "<{$element_tag}{$element_attr}>" . $node->nodeValue . "</{$element_tag}>";
                        }
                    }
                    else if($is_field_atom_reference){
                        $image_info=_parse_image_value($node->nodeValue);
                        if(count($image_info)) {
                            $image_name = $image_info['image_name'];
                            $image_sid = _move_from_temp($images[$image_name],$image_info);
                            $tag = $image_sid;
                        }
                        else{
                            form_set_error('IDT',"Class {$class} does not have valid value!");
                        }

                    }
                }
                if(!empty($tag))
                    $field_value[] = $tag;
            }
        }
        if(isset($field_value) && count($field_value)) {
            $value = implode(' ',$field_value);
            if ($is_field_text_area) {
                $result[$field['name']]['und'][0]['value'] = $value;
                $result[$field['name']]['und'][0]['safe_value'] = $value;
                $result[$field['name']]['und'][0]['format'] = 'wysiwyg';
                if (preg_match('/_with_summary/i', $field['type'])) {
                    //remove tag by using of regex.
                    $result[$field['name']]['und'][0]['summary'] = preg_replace('/<.[^>]*>/i', '', substr($value, 0, 170));
                    $result[$field['name']]['und'][0]['safe_summary'] = preg_replace('/<.[^>]*>/i', '', substr($value, 0, 170));
                }
            }
            else if($is_field_atom_reference){
                $result[$field['name']] = array('und' => array());
                foreach ($field_value as $atom => $sid) {
                    $result[$field['name']]['und'][] = array('sid' => $sid);
                }
            }
            else if(preg_match('/^textfield$/i',$field['type'])){
                $result[$field['name']]=$value;
            }
            else{
                $result[$field['name']] = array(
                    'und'=> array(
                        array(
                            'value' => $value,
                        ),
                    ),
                );
            }
        }
    }
    if(count($result)) {
        _create_node($result);
    }
    else{
        form_set_error('itd',"No field has been set to import, please check setting of 'Indesign to Drupal module' ");
    }
}


/**
 * @param $temp_file
 *  array of temp file's info
 * @return int/bool
 *  return atom sid.
 */
function _move_from_temp($temp_file,$values){
    $scheme = variable_get('file_default_scheme', 'public') . '://';
    $source = $temp_file['tmppath'];
    $destination = file_stream_wrapper_uri_normalize($scheme . $temp_file['name']);
    // Rename it to its original name, and put it in its final home.
    // Note - not using file_move here because if we call file_get_mime
    // (in file_uri_to_object) while it has a .tmp extension, it horks.
    $destination = file_unmanaged_move($source, $destination, FILE_EXISTS_RENAME);
    $file = plupload_file_uri_to_object($destination);
    file_save($file);
    // Create an atom

    //Set Image text if it is set
    $image_text = array();
    if ($values['field_image_text']){
        $image_text = array(
            'und' => array(
                array(
                    'value' => $values['field_image_text'],
                    'safe_value' => 'safe value',
                    'format' => '',
                ),
            ),
        );
    }

    //Set Image byline
    $image_byline = array();
    if ($values['field_image_byline']){
        $image_byline = array(
            'und' => array(
                array(
                    'value' => $values['field_image_byline'],
                    'safe_value' => 'safe value',
                    'format' => '',
                ),
            ),
        );
    }

    $atom = new ScaldAtom('image','scald_image', array(
        'base_id' => $file->fid,
        'title' => $file->filename,
        'field_image_text' => $image_text,
        'field_image_byline' =>$image_byline,
    ));
    $langcode = field_language('scald_atom', $atom, 'scald_thumbnail');
    $atom->scald_thumbnail[$langcode][0] = (array) $file;
    $atom_sid=scald_atom_save($atom);
    return $atom_sid;
}

function _create_node($value)
{
    $node = new idtNode('article',$value);
    $node->saveNode();
}

function _parse_image_value($value){
    $result=array();
    $image_delimiter = "*";
    $image_info = explode($image_delimiter,$value);
    $result = array(
        'image_name' => $image_info[0],
    );
    if(isset($image_info[1]))
        $result['field_image_text'] = $image_info[1];
    if(isset($image_info[2]))
        $result['field_image_byline'] = $image_info[2];

    return $result;

}

function _atom_image_wrapper($atom){
    $return = array();
    if(isset($atom->field_image_text['und'][0]['value'])) {
        $return['items']['image_text'] ="<div class ='image-text'>" . $atom->field_image_text['und'][0]['value'] . "</div>";
    }
    if(isset($atom->field_image_byline['und'][0]['value'])) {
        $return['items']['image_byline'] ="<div class ='image-byline'>" . $atom->field_image_byline['und'][0]['value'] . "</div>";
    }

    if(isset($return['items']['image_txt']) || isset($return['items']['image_byline'])) {
        $return['items']['image_extra_wrapper'] = "<div class ='image-extra-wrapper'>";
        $return['items']['image_extra_wrapper'] .=(isset($return['items']['image_text']))? $return['items']['image_text'] : '';
        $return['items']['image_extra_wrapper'] .=(isset($return['items']['image_byline']))? $return['items']['image_byline'] : '';
        $return['items']['image_extra_wrapper'] .= "</div>";
    }
    $image_path = image_style_url('large', $atom->file_source);
    $title=(isset($atom->field_image_text['und'][0]['value']))? $atom->field_image_text['und'][0]['value'] : $atom->title;
    $return['items']['image_tag'] = "<img class='large' src='{$image_path}' title='{$title}' alt='{$title}'>" ;

    $return['render']  = '<div class="dnd-atom-wrapper type-image context-sdl_editor_representation" contenteditable="false">';
    $return['render'] .= "<div class='dnd-drop-wrapper'><div class ='image'>";
    $return['render'] .= $return['items']['image_tag'];
    $return['render'] .= (isset($return['items']['image_extra_wrapper']))? $return['items']['image_extra_wrapper'] : '';
    $return['render'] .= "</div></div>";
    $return['render'] .= "</div>";


    return $return;
}